<!-- ServoDevelop Wiki â€” custom head -->
<!-- Loads custom CSS + generates a right-side "On this page" TOC (desktop) -->

<link rel="stylesheet" href="{{ '/assets/css/just-the-docs-custom.css' | relative_url }}">

<script>
(function () {
  function slugify(text) {
    try {
      return (text || '')
        .toString()
        .trim()
        .toLowerCase()
        // keep letters/numbers from most scripts by using a simple whitespace->dash, then strip unsafe chars
        .replace(/[\s\u00A0]+/g, '-')
        .replace(/[^\p{L}\p{N}_\-]+/gu, '')
        .replace(/\-+/g, '-')
        .replace(/^\-+|\-+$/g, '');
    } catch (e) {
      // Fallback for browsers without unicode property escapes
      return (text || '')
        .toString()
        .trim()
        .toLowerCase()
        .replace(/[\s\u00A0]+/g, '-')
        .replace(/[^a-z0-9_\-]+/g, '')
        .replace(/\-+/g, '-')
        .replace(/^\-+|\-+$/g, '');
    }
  }

  function ensureId(el, idx) {
    if (el.id) return el.id;

    var base = slugify(el.textContent);
    if (!base) base = 'section-' + (idx + 1);

    var id = base;
    var i = 2;
    while (document.getElementById(id)) {
      id = base + '-' + (i++);
    }
    el.id = id;
    return id;
  }

  function buildPageToc() {
    // Avoid duplicate TOCs
    if (document.getElementById('page-toc')) return;

    var main = document.querySelector('.main-content');
    if (!main) return;

    var headings = Array.prototype.slice.call(main.querySelectorAll('h2, h3, h4'));
    if (!headings.length) return;

    var aside = document.createElement('aside');
    aside.id = 'page-toc';
    aside.className = 'page-toc';
    aside.setAttribute('aria-label', 'On this page');

    aside.innerHTML = '' +
      '<div class="page-toc-title">On this page</div>' +
      '<ul class="page-toc-list"></ul>';

    var ul = aside.querySelector('.page-toc-list');

    headings.forEach(function (h, idx) {
      var id = ensureId(h, idx);

      var li = document.createElement('li');
      li.className = 'lvl-' + h.tagName.toLowerCase();

      var a = document.createElement('a');
      a.href = '#' + id;
      a.textContent = h.textContent;

      li.appendChild(a);
      ul.appendChild(li);
    });

    document.body.appendChild(aside);

    // Highlight active section (nice-to-have; safe fallback)
    try {
      if ('IntersectionObserver' in window) {
        var linkById = {};
        aside.querySelectorAll('a[href^="#"]').forEach(function (a) {
          linkById[a.getAttribute('href').slice(1)] = a;
        });

        var current = null;
        var obs = new IntersectionObserver(function (entries) {
          // Pick the top-most visible heading
          var visible = entries
            .filter(function (e) { return e.isIntersecting; })
            .sort(function (a, b) { return a.boundingClientRect.top - b.boundingClientRect.top; });

          if (!visible.length) return;

          var id = visible[0].target.id;
          if (!id || id === current) return;

          current = id;
          aside.querySelectorAll('a.is-active').forEach(function (a) { a.classList.remove('is-active'); });
          if (linkById[id]) linkById[id].classList.add('is-active');
        }, {
          root: null,
          rootMargin: '-20% 0px -70% 0px',
          threshold: [0, 1]
        });

        headings.forEach(function (h) { obs.observe(h); });
      }
    } catch (e) {}
  }

  function syncExpanded() {
    try {
      document.querySelectorAll('.nav-list-item').forEach(function (li) {
        li.classList.remove('is-expanded');
      });
      document.querySelectorAll('.nav-list-expander[aria-expanded="true"]').forEach(function (btn) {
        var li = btn.closest('.nav-list-item');
        if (li) li.classList.add('is-expanded');
      });
    } catch (e) {}
  }

  document.addEventListener('DOMContentLoaded', function () {
    try { buildPageToc(); } catch (e) {}
    try {
      syncExpanded();
      document.querySelectorAll('.nav-list-expander').forEach(function (btn) {
        btn.addEventListener('click', function () { setTimeout(syncExpanded, 0); });
      });
    } catch (e) {}
  });
})();
</script>
